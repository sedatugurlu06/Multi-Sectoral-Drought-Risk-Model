# --- 0. SETUP & LIBRARIES ---
if (!require("pacman")) install.packages("pacman")
pacman::p_load(sf, tidyverse, rstudioapi)

# Force Working Directory to Script Location
if (rstudioapi::isAvailable()) {
  setwd(dirname(getActiveDocumentContext()$path))
}
print(paste("Working in:", getwd()))

# --- 1. CONFIGURATION ---
BASIN_PATH <- "../shp/hybas_eu_lev06_v1c.shp"
NUTS_PATH  <- "../shp/NUTS_RG_03M_2024_3035.shp" 

OUTPUT_CSV <- "basin_smart_weights.csv"

# --- 2. LOAD DATA ---
message("Loading Shapefiles...")
basins <- st_read(BASIN_PATH, quiet = TRUE)
nuts   <- st_read(NUTS_PATH, quiet = TRUE)

# --- 3. PREPARE & REPROJECT ---
message("Standardizing Projections (EPSG:3035)...")
# We use EPSG:3035 (LAEA Europe) for accurate area calculations
target_crs <- 3035

basins <- st_transform(basins, target_crs)
nuts   <- st_transform(nuts, target_crs)

# Clean NUTS: Select only essential columns to speed up intersection
# Assuming standard Eurostat columns: NUTS_ID, LEVL_CODE, CNTR_CODE
nuts <- nuts %>% select(NUTS_ID, LEVL_CODE, CNTR_CODE)

# Calculate ORIGINAL Basin Area (km2) before chopping them up
basins <- basins %>%
  mutate(total_area_km2 = as.numeric(st_area(.)) / 1e6) %>%
  select(HYBAS_ID, total_area_km2) # Keep only ID and Area

# --- 4. INTERSECTION (The Heavy Lifting) ---
message("Running Intersection (This may take a few minutes)...")
# This cuts the basins into pieces along the NUTS borders
intersection <- st_intersection(basins, nuts)

# --- 5. CALCULATE WEIGHTS ---
message("Calculating Area Weights...")

# Calculate area of the new pieces
intersection <- intersection %>%
  mutate(
    piece_area_km2 = as.numeric(st_area(.)) / 1e6,
    # Calculate Weight: Piece Area / Original Basin Area
    weight = piece_area_km2 / total_area_km2
  ) %>%
  # Filter out tiny slivers (less than 0.1% overlap) to keep data clean
  filter(weight > 0.001)

# --- 6. THE "SMART" ID EXTRACTION ---
# Create columns for EVERY NUTS level automatically
message("Extracting NUTS Parent IDs...")

intersection <- intersection %>%
  mutate(
    NUTS_ID   = as.character(NUTS_ID),
    NUTS_0_ID = substr(NUTS_ID, 1, 2), # First 2 chars (Country, e.g., DE)
    NUTS_1_ID = substr(NUTS_ID, 1, 3), # First 3 chars (Major, e.g., DE1)
    NUTS_2_ID = substr(NUTS_ID, 1, 4), # First 4 chars (Basic, e.g., DE11)
    NUTS_3_ID = NUTS_ID                # Full ID
  )

# --- 7. SAVE TO CSV ---
# Drop geometry (we don't need shapes anymore, just data)
final_table <- intersection %>%
  st_drop_geometry() %>%
  select(HYBAS_ID, NUTS_0_ID, NUTS_1_ID, NUTS_2_ID, NUTS_3_ID, weight, piece_area_km2)

write_csv(final_table, OUTPUT_CSV)

message(paste("Success! Saved weights to:", OUTPUT_CSV))

print(head(final_table))
