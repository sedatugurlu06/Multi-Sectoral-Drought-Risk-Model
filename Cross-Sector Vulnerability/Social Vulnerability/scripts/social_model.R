# ==============================================================================
# PROJECT: DROUGHT RISK THESIS - SOCIAL VULNERABILITY
# SCRIPT: social_model.R
# ==============================================================================

library(sf)
library(tidyverse)
library(leaflet)
library(giscoR)
library(countrycode)
library(htmlwidgets)

# --- FORCE WORKING DIRECTORY TO SCRIPT LOCATION ---
if (rstudioapi::isAvailable()) {
  library(rstudioapi)
  # This sets the working directory to the folder containing this specific file
  setwd(dirname(getActiveDocumentContext()$path))
}
print(paste("Current Working Directory locked to:", getwd()))
# --------------------------------------------------

# 1. CONFIGURATION BLOCK
CONFIG <- list(
  gender = list(
    name = "Gender Equality",
    file = "../data/cleaned_gender_final.csv",  
    join_col = "ISO_CODE",
    value_col = "Gender_Score",
    level = "Country",
    weight = 0.15,
    s_curve = "decreasing",
    steepness = 5.0
  ),
  rural = list(
    name = "Rural Population",
    file = "../data/clean_rural_pop_percentage.csv",
    join_col = "geo",
    value_col = "Avg_Rural_Pop_Pct",
    level = "NUTS2",
    weight = 0.30,
    s_curve = "increasing",
    steepness = 5.0
  ),
  arope = list(
    name = "Poverty Risk (AROPE)",
    file = "../data/clean_poverty_risk_rate.csv",
    join_col = "geo",
    value_col = "Avg_Poverty_Rate",
    level = "NUTS2",
    weight = 0.15,
    s_curve = "increasing",
    steepness = 5.0
  ),
  dependency = list(
    name = "Social Dependency",
    file = "../data/clean_social_dependency.csv",
    join_col = "geo",
    value_col = "Avg_Dependency_Ratio",
    level = "NUTS3",
    weight = 0.15,
    s_curve = "increasing",
    steepness = 5.0
  ),
  hdi = list(
    name = "Human Development Index",
    file = "../data/clean_hdi_aquastat.csv",
    join_col = "ISO_CODE",
    value_col = "Avg_HDI_National",
    level = "Country",
    weight = 0.25,
    s_curve = "decreasing",
    steepness = 5.0
  )
)

# 2. DEFINE S-CURVE FUNCTIONS
s_curve_increasing <- function(x, b, k) {
  if(is.na(b)) return(x)
  1 / (1 + (b / x)^k)
}

s_curve_decreasing <- function(x, b, k) {
  if(is.na(b)) return(x)
  ifelse(x == 0, 1, 1 / (1 + (x / b)^k))
}

normalize_data <- function(values, type, steepness) {
  midpoint <- mean(values, na.rm = TRUE)
  if(is.nan(midpoint)) return(rep(NA, length(values)))
  
  if (type == "increasing") {
    return(s_curve_increasing(values, midpoint, steepness))
  } else {
    return(s_curve_decreasing(values, midpoint, steepness))
  }
}

# 3. LOAD GEOMETRY
print("Loading Geometry...")

# Get Europe Country Codes
europe_geo <- gisco_get_countries(year = "2020", region = "Europe")
allowed_countries_geo <- europe_geo %>% filter(!CNTR_ID %in% c("RU", "TR")) 
allowed_codes <- allowed_countries_geo$CNTR_ID


basin_shp <- st_read("../shp/hybas_eu_lev06_v1c.shp") 

# Transform and Filter
basin_shp <- st_transform(basin_shp, 3035)
europe_mask <- allowed_countries_geo %>% st_transform(3035)
basin_shp <- st_filter(basin_shp, europe_mask)

print(paste("Basins loaded:", nrow(basin_shp)))

# Load Admin Maps
countries_shp <- gisco_get_nuts(year = "2021", nuts_level = 0, country = allowed_codes) %>% st_transform(3035)
nuts2_shp <- gisco_get_nuts(year = "2021", nuts_level = 2, country = allowed_codes) %>% st_transform(3035)
nuts3_shp <- gisco_get_nuts(year = "2021", nuts_level = 3, country = allowed_codes) %>% st_transform(3035)


# 4. PROCESSING FUNCTION
process_indicator <- function(basin_sf, config_item, admin_sf) {
  message(paste(">>> Processing:", config_item$name, "..."))
  
  if (!file.exists(config_item$file)) stop(paste("File not found:", config_item$file))
  df <- read_csv(config_item$file, show_col_types = FALSE)
  
  if (!config_item$join_col %in% names(df)) stop("Join column missing")
  if (!config_item$value_col %in% names(df)) stop("Value column missing")
  
  df$GEO_ID <- df[[config_item$join_col]]
  df$RAW_VALUE <- as.numeric(df[[config_item$value_col]])
  
  df <- df %>% filter(!is.na(GEO_ID) & !is.na(RAW_VALUE))
  
  if(config_item$level == "Country") {
    df$GEO_ID[df$GEO_ID == "GR"] <- "EL"
    df$GEO_ID[df$GEO_ID == "GB"] <- "UK"
    admin_sf <- admin_sf %>% rename(GEO_ID = NUTS_ID)
  } else {
    admin_sf <- admin_sf %>% rename(GEO_ID = NUTS_ID)
  }
  
  map_layer <- admin_sf %>% inner_join(df, by = "GEO_ID")
  
  if(nrow(map_layer) == 0) stop(paste("No matching regions for", config_item$name))
  
  intersection <- st_intersection(basin_sf, map_layer)
  intersection$area_w <- as.numeric(st_area(intersection))
  
  basin_stats <- intersection %>%
    st_drop_geometry() %>%
    group_by(HYBAS_ID) %>%
    summarise(
      weighted_raw_val = sum(RAW_VALUE * area_w, na.rm=T) / sum(area_w, na.rm=T)
    )
  
  basin_stats$norm_score <- normalize_data(
    basin_stats$weighted_raw_val, 
    config_item$s_curve, 
    config_item$steepness
  )
  
  result <- basin_stats %>% select(HYBAS_ID, norm_score, weighted_raw_val)
  names(result) <- c("HYBAS_ID", paste0("VULN_", config_item$name), paste0("RAW_", config_item$name))
  return(result)
}

# 5. EXECUTE MODEL
master_data <- basin_shp %>% st_drop_geometry() %>% select(HYBAS_ID)

safe_process <- function(data, cfg, map) {
  res <- process_indicator(basin_shp, cfg, map)
  left_join(data, res, by="HYBAS_ID")
}

master_data <- safe_process(master_data, CONFIG$gender, countries_shp)
master_data <- safe_process(master_data, CONFIG$rural, nuts2_shp)
master_data <- safe_process(master_data, CONFIG$arope, nuts2_shp)
master_data <- safe_process(master_data, CONFIG$dependency, nuts3_shp)
master_data <- safe_process(master_data, CONFIG$hdi, countries_shp)

# 6. CALCULATE INDEX
master_data <- master_data %>%
  mutate(
    Social_Vulnerability_Index = 
      (`VULN_Gender Equality` * CONFIG$gender$weight) +
      (`VULN_Rural Population` * CONFIG$rural$weight) +
      (`VULN_Poverty Risk (AROPE)` * CONFIG$arope$weight) +
      (`VULN_Social Dependency` * CONFIG$dependency$weight) +
      (`VULN_Human Development Index` * CONFIG$hdi$weight)
  ) %>%
  filter(Social_Vulnerability_Index > 0)

final_map_sf <- basin_shp %>%
  inner_join(master_data, by = "HYBAS_ID") 

# 7. SAVE OUTPUT

print("Saving data...")
saveRDS(final_map_sf, "../data/ready_to_map_data.rds")

print("DONE! Now run app.R")
